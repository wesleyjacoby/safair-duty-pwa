<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Duty Tracker</title>

    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#f7f8fa" />
    <meta name="apple-mobile-web-app-title" content="Duty Tracker" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <link rel="apple-touch-icon" href="icons/icon-512.png" />
    <link rel="icon" sizes="192x192" href="icons/icon-192.png" />
    <link rel="manifest" href="manifest.webmanifest" />

    <link rel="stylesheet" href="assets/app.css" />

    <script defer src="vendor/luxon.min.js"></script>
    <script defer src="vendor/dexie.min.js"></script>

    <script type="module" src="assets/app.js"></script>
</head>
<body>
    <header class="topbar container">
        <h1>Duty Tracker</h1>
        <div class="sp"></div>

        <button id="themeBtn" class="btn ghost toggle" aria-pressed="false" type="button">Dark</button>

        <button id="btnExport" class="btn ghost" title="Export JSON/CSV">Export</button>
        <button id="btnImport" class="btn ghost" title="Import JSON">Import</button>
        <input id="importFile" type="file" accept="application/json" hidden />
    </header>

    <main class="container">

        <!-- NEW DUTY -->
        <section class="panel">
            <div class="panel-header">
                <h2>New Duty</h2>
                <div class="muted small">
                    For Standby: log the standby window below. If called out, enter the FDP Report/Off here too.
                </div>
            </div>

            <form id="dutyForm">
                <div class="grid two">
                    <label>Duty Type
                        <select id="dutyType" name="dutyType">
                            <option>FDP</option>
                            <option>Standby</option>
                            <option>Ground</option>
                            <option>Training</option>
                            <option>Office</option>
                            <option>Positioning</option>
                            <option>Flight Watch</option>
                            <option>Home Reserve</option>
                            <option>Sick</option>
                        </select>
                    </label>

                    <label>Sign On (local)
                        <input type="datetime-local" id="report" name="report" />
                    </label>

                    <label>Sign Off (local)
                        <input type="datetime-local" id="off" name="off" />
                    </label>

                    <label>Sectors (count)
                        <input type="number" id="sectors" name="sectors" min="0" max="8" value="2" />
                    </label>

                    <label>Location
                        <select id="location" name="location">
                            <option>Home</option>
                            <option>Away</option>
                        </select>
                    </label>

                    <label>Discretion Used? (mins)
                        <input type="number" id="discretionMins" name="discretionMins" min="0" step="1"
                            placeholder="0" />
                    </label>
                </div>

                <!-- STANDBY / RESERVE -->
                <fieldset id="sbSection" class="fieldset sbcard" style="margin-top:16px; display:none;">
                    <legend>Standby / Reserve</legend>

                    <div class="muted small" style="margin-bottom:8px">
                        Log the standby window. If you’re called out, also fill Report/Off above for the resulting FDP.
                    </div>

                    <div class="grid three roomy">
                        <label>Standby Type
                            <select id="sbType" name="sbType">
                                <option>Home</option>
                                <option>Airport</option>
                            </select>
                        </label>

                        <label>Window Start (local)
                            <input type="datetime-local" id="sbStart" name="sbStart" />
                        </label>

                        <label>Window End (local)
                            <input type="datetime-local" id="sbEnd" name="sbEnd" />
                        </label>
                    </div>

                    <div class="grid three roomy">
                        <label>Called out?
                            <!-- Segmented Yes/No control -->
                            <div class="seg" id="sbSeg" role="group" aria-label="Called out">
                                <input type="radio" id="sbNo" name="sbCalledSeg" value="0" />
                                <label for="sbNo">No</label>
                                <input type="radio" id="sbYes" name="sbCalledSeg" value="1" />
                                <label for="sbYes">Yes</label>
                            </div>
                            <!-- Hidden checkbox used by JS / existing logic -->
                            <input type="checkbox" id="sbCalled" name="sbCalled" hidden />
                        </label>

                        <label>Call Time (local)
                            <input type="datetime-local" id="sbCall" name="sbCall" />
                        </label>

                        <label>Converted FDP Start (info)
                            <input type="text" id="sbConvertedFdp" placeholder="auto-calc later" disabled />
                        </label>
                    </div>
                </fieldset>

                <div class="actions">
                    <button class="btn primary" type="submit">Save Duty</button>
                    <button id="btnWhatIf" class="btn ghost" type="button"
                        title="Simulate this duty (not saved)">What-if</button>
                    <button id="btnDeleteDuty" class="btn danger" type="button" title="Delete selected duty">
                        Delete Duty
                    </button>
                    <button id="btnEditDuty" class="btn ghost" type="button" title="Edit selected">Edit
                        selected</button>
                    <button id="btnCancelEdit" class="btn ghost" type="button" title="Cancel edit">Cancel edit</button>
                </div>
            </form>
        </section>

        <!-- DUTY LEGALITY -->
        <section class="panel">
            <div class="panel-header">
                <h2>Duty Legality</h2>
                <div class="muted small" id="legalityContext">Select a duty from the log.</div>
            </div>
            <div id="legalityBadges" class="badges badges-xl"></div>
            <div id="legalityNotes" class="small muted" style="margin-top:8px; display:none;"></div>

            <!-- WHAT-IF (Pro): Planning Mode (not saved) -->
            <div id="whatIfWrap" class="whatif" style="display:none; margin-top:12px;">

                <!-- Header / Preview cue -->
                <div class="whatif-head">
                    <span class="whatif-pill">Preview</span>
                    <div id="whatIfContext" class="muted small">
                        Assumes no other duties before this date.
                    </div>
                </div>

                <!-- Planning bar -->
                <div id="planBar" class="planbar">
                    <div class="planbar-left">
                        <button id="btnAddAssumption" class="btn small ghost" type="button" aria-expanded="false"
                            aria-controls="assumptionMenu" title="Add a planning assumption">
                            Add assumption ▾
                        </button>

                        <span id="assumptionCount" class="muted small" style="margin-left:8px;">Assumptions: 0</span>
                    </div>

                    <button id="btnClearAssumptions" class="btn small ghost" type="button"
                        title="Clear planning assumptions">
                        Clear
                    </button>
                </div>

                <!-- Dropdown / popover -->
                <div id="assumptionMenu" class="assump-menu" role="menu" aria-label="Add assumption"
                    style="display:none;">
                    <button class="assump-item" type="button" data-kind="work" role="menuitem">Work day</button>
                    <button class="assump-item" type="button" data-kind="standby" role="menuitem">Standby</button>
                    <button class="assump-item" type="button" data-kind="off" role="menuitem">Off day</button>
                </div>

                <!-- Inline editor (changes based on selection) -->
                <div id="assumptionEditor" class="assump-editor" style="display:none;">
                    <div class="assump-editor-head">
                        <div id="assumptionEditorTitle" style="font-weight:700;">Add assumption</div>
                        <div class="muted small">Applies to the days before the What-if date.</div>
                    </div>

                    <div id="assumptionEditorBody" class="grid two" style="margin-top:10px;">
                        <!-- JS will inject fields here -->
                    </div>

                    <div class="actions" style="margin-top:10px;">
                        <button id="btnAssumptionAdd" class="btn primary small" type="button">Add</button>
                        <button id="btnAssumptionCancel" class="btn ghost small" type="button">Cancel</button>
                    </div>
                </div>

                <!-- Assumptions list (dashed preview box) -->
                <div id="assumptionListWrap" class="assump-list" style="display:none;">
                    <div class="assump-list-head">
                        <span class="assump-list-pill">Planning assumptions</span>
                        <span class="muted small">Preview only — not saved.</span>
                    </div>
                    <ul id="assumptionList" style="margin:10px 0 0; padding-left:18px;"></ul>
                </div>

                <!-- Preview badges -->
                <div id="whatIfBadges" class="badges" style="margin-top:10px;"></div>
            </div>


        </section>

        <!-- QUICK STATS -->
        <section class="panel">
            <div class="panel-header">
                <h2>Averages & Counts</h2>
                <div class="muted small">Rolling, lightweight summaries.</div>
            </div>
            <div class="badges" id="quickStats"></div>
        </section>

        <!-- FLAGGED ITEMS -->
        <section class="panel">
            <div class="panel-header">
                <h2>Flagged Items</h2>
                <div class="muted small">Anything that violated or came close to a limit.</div>
            </div>
            <ul id="flagsFeed" class="feed"></ul>
        </section>

        <!-- DUTY LOG -->
        <section class="panel">
            <div class="panel-header">
                <h2>Duty Log</h2>
                <div class="muted small">↑/↓ to change selection; Del to delete selected.</div>
            </div>
            <div id="history"></div>
        </section>
    </main>

    <footer class="container footer">
        <div class="small muted"><span id="versionStamp" title="OM tables aligned"></span></div>
        <div><button id="btnClear" class="btn danger">Clear All (local)</button></div>
    </footer>

    <div id="updateBar" class="panel container" role="status" aria-live="polite" style="display:none">
        A new version is available.
        <button id="btnUpdateNow" class="btn primary small">Reload</button>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const reg = await navigator.serviceWorker.register('./sw.js');
                    reg.addEventListener('updatefound', () => {
                        const nw = reg.installing;
                        if (!nw) return;
                        nw.addEventListener('statechange', () => {
                            if (nw.state === 'installed' && navigator.serviceWorker.controller) {
                                const bar = document.getElementById('updateBar');
                                if (bar) bar.style.display = 'block';
                            }
                        });
                    });
                    navigator.serviceWorker.addEventListener('controllerchange', () => window.location.reload());
                    const btn = document.getElementById('btnUpdateNow');
                    if (btn) btn.addEventListener('click', async () => {
                        const reg2 = await navigator.serviceWorker.getRegistration();
                        if (reg2?.waiting) reg2.waiting.postMessage('SKIP_WAITING');
                        else if (reg2?.active) reg2.active.postMessage('SKIP_WAITING');
                    });
                } catch (e) { console.error('SW reg failed', e); }
            });
        }
    </script>
</body>
</html>